var B=(b,f)=>()=>(f||b((f={exports:{}}).exports,f),f.exports);var S=B((w,y)=>{/**
 * @file image-editor.js
 * @module image-editor
 * @version 1.0
 * @author Ben Situ
 * @license MIT
 * @description Lightweight canvas-based image editor with masking/transform/export support.
 *
 * This source file is free software, available under the MIT license.
 * It is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
 * See the license files for details.
 */(function(b,f){typeof define=="function"&&define.amd?define([],f):typeof y=="object"&&y.exports?y.exports=f():b.ImageEditor=f()})(typeof self<"u"?self:w,function(){"use strict";class b{constructor(t={}){this._fabricLoaded=typeof fabric<"u",this._fabricLoaded||console.error("fabric.js is not loaded. Please include fabric.js first. Initialization will be aborted."),this.options={canvasWidth:800,canvasHeight:600,backgroundColor:"#ffffff",animationDuration:300,minScale:.1,maxScale:5,scaleStep:.05,rotationStep:90,expandCanvasToImage:!0,fitImageToCanvas:!1,downsampleOnLoad:!0,downsampleMaxWidth:4e3,downsampleMaxHeight:3e3,downsampleQuality:.92,exportMultiplier:1,exportImageAreaByDefault:!0,defaultMaskWidth:50,defaultMaskHeight:80,maskRotatable:!1,maskLabelOnSelect:!0,maskLabelOffset:3,maskName:"mask",groupSelection:!1,showPlaceholder:!0,initialImageBase64:null,defaultDownloadFileName:"edited_image.jpg",...t},this.options.label={getText:(i,e)=>i.maskName,textOptions:{fontSize:12,fill:"#fff",backgroundColor:"rgba(0,0,0,0.7)",padding:2,fontFamily:"monospace",fontWeight:"bold",selectable:!1,evented:!1,originX:"left",originY:"top"}},this.canvas=null,this.canvasEl=null,this.containerEl=null,this.placeholderEl=null,this.originalImage=null,this.baseImageScale=1,this.currentScale=1,this.currentRotation=0,this.maskCounter=0,this.isAnimating=!1,this.elements={},this.isImageLoadedToCanvas=!1,this.maxHistorySize=50,this._boundHandlers={},this._lastMaskInitialLeft=null,this._lastMaskInitialTop=null,this._lastMaskInitialWidth=null,this.onImageLoaded=typeof t.onImageLoaded=="function"?t.onImageLoaded:null,this.animQueue=new f,this.historyManager=new L(this.maxHistorySize)}init(t={}){if(!this._fabricLoaded)return;let i={canvas:"fabricCanvas",canvasContainer:null,imgPlaceholder:"imgPlaceholder",scaleRate:"scaleRate",rotationLeftInput:"rotationLeftInput",rotationRightInput:"rotationRightInput",rotateLeftBtn:"rotateLeftBtn",rotateRightBtn:"rotateRightBtn",addMaskBtn:"addMaskBtn",removeMaskBtn:"removeMaskBtn",removeAllMasksBtn:"removeAllMasksBtn",mergeBtn:"mergeBtn",downloadBtn:"downloadBtn",maskList:"maskList",zoomInBtn:"zoomInBtn",zoomOutBtn:"zoomOutBtn",resetBtn:"resetBtn",undoBtn:"undoBtn",redoBtn:"redoBtn",imageInput:"imageInput"};this.elements={...i,...t},this._initCanvas(),this._bindEvents(),this._updateInputs(),this._updateMaskList(),this._updateUI(),this.options.initialImageBase64?this.loadImage(this.options.initialImageBase64):this._updatePlaceholderStatus()}_initCanvas(){let t=document.getElementById(this.elements.canvas);if(!t)throw new Error("Canvas is not found: "+this.elements.canvas);if(this.canvasEl=t,this.elements.canvasContainer){let s=document.getElementById(this.elements.canvasContainer);this.containerEl=s||t.parentElement}else this.containerEl=t.parentElement;this.placeholderEl=document.getElementById(this.elements.imgPlaceholder)||null;let i=this.options.canvasWidth,e=this.options.canvasHeight;if(this.containerEl){let s=Math.floor(this.containerEl.clientWidth),a=Math.floor(this.containerEl.clientHeight);s>0&&a>0&&(i=s,e=a)}this.canvas=new fabric.Canvas(t,{width:i,height:e,backgroundColor:this.options.backgroundColor,selection:this.options.groupSelection,preserveObjectStacking:!0}),this.canvas.on("selection:created",s=>this._onSelectionChanged(s.selected)),this.canvas.on("selection:updated",s=>this._onSelectionChanged(s.selected)),this.canvas.on("selection:cleared",()=>this._onSelectionChanged([])),this.canvas.on("object:moving",s=>{s.target&&s.target.maskId&&this._syncMaskLabel(s.target)}),this.canvas.on("object:scaling",s=>{s.target&&s.target.maskId&&this._syncMaskLabel(s.target)}),this.canvas.on("object:rotating",s=>{s.target&&s.target.maskId&&this._syncMaskLabel(s.target)}),this.canvas.on("object:modified",s=>{s.target&&s.target.maskId&&this._syncMaskLabel(s.target)}),this.canvasEl.style.display="block"}_bindEvents(){this._bindIfExists("uploadArea","click",()=>document.getElementById(this.elements.imageInput)?.click());let t=document.getElementById(this.elements.imageInput);t&&t.addEventListener("change",s=>{let a=s.target.files&&s.target.files[0];a&&this._loadImageFile(a)}),this._bindIfExists("zoomInBtn","click",()=>this.scaleImage(this.currentScale+this.options.scaleStep)),this._bindIfExists("zoomOutBtn","click",()=>this.scaleImage(this.currentScale-this.options.scaleStep)),this._bindIfExists("resetBtn","click",()=>{this.reset()}),this._bindIfExists("addMaskBtn","click",()=>this.addMask()),this._bindIfExists("removeMaskBtn","click",()=>this.removeSelectedMask()),this._bindIfExists("removeAllMasksBtn","click",()=>this.removeAllMasks()),this._bindIfExists("mergeBtn","click",()=>this.merge()),this._bindIfExists("downloadBtn","click",()=>this.downloadImage()),this._bindIfExists("undoBtn","click",()=>this.undo()),this._bindIfExists("redoBtn","click",()=>this.redo());let i=document.getElementById(this.elements.rotateLeftBtn),e=document.getElementById(this.elements.rotateRightBtn);i&&i.addEventListener("click",()=>{let s=document.getElementById(this.elements.rotationLeftInput),a=this.options.rotationStep;if(s){let o=parseFloat(s.value);isNaN(o)||(a=o)}this.rotateImage(this.currentRotation-a)}),e&&e.addEventListener("click",()=>{let s=document.getElementById(this.elements.rotationRightInput),a=this.options.rotationStep;if(s){let o=parseFloat(s.value);isNaN(o)||(a=o)}this.rotateImage(this.currentRotation+a)})}_bindIfExists(t,i,e){let s=document.getElementById(this.elements[t]);s&&(s.addEventListener(i,e),this._boundHandlers=this._boundHandlers||{},this._boundHandlers[t]||(this._boundHandlers[t]=[]),this._boundHandlers[t].push({event:i,handler:e}))}_loadImageFile(t){if(!t||!t.type.startsWith("image/"))return;let i=new FileReader;i.onload=e=>this.loadImage(e.target.result),i.onerror=e=>{console.error("[ImageEditor: fileReadError]",e)},i.readAsDataURL(t)}async loadImage(t){if(!this._fabricLoaded||!t||typeof t!="string"||!t.startsWith("data:image/"))return;this._setPlaceholderVisible(!1);let i=await this._createImageElement(t),e=t;if(this.options.downsampleOnLoad&&(i.naturalWidth>this.options.downsampleMaxWidth||i.naturalHeight>this.options.downsampleMaxHeight)){let a=Math.min(this.options.downsampleMaxWidth/i.naturalWidth,this.options.downsampleMaxHeight/i.naturalHeight),o=Math.round(i.naturalWidth*a),h=Math.round(i.naturalHeight*a);e=this._resampleImageToDataURL(i,o,h,this.options.downsampleQuality)}fabric.Image.fromURL(e,s=>{this.canvas.discardActiveObject(),this._hideAllMaskLabels(),this.canvas.clear(),this.canvas.setBackgroundColor(this.options.backgroundColor,this.canvas.renderAll.bind(this.canvas)),s.set({originX:"left",originY:"top",selectable:!1,evented:!1});let a=s.width,o=s.height,h=this.containerEl?Math.floor(this.containerEl.clientWidth||this.options.canvasWidth):this.options.canvasWidth,n=this.containerEl?Math.floor(this.containerEl.clientHeight||this.options.canvasHeight):this.options.canvasHeight;if(this.options.fitImageToCanvas){let c=Math.max(this.options.canvasWidth,h),d=Math.max(this.options.canvasHeight,n);this._setCanvasSizeInt(c,d);let r=Math.min(c/a,d/o,1);s.set({left:(c-a*r)/2,top:(d-o*r)/2}),s.scale(r),this.baseImageScale=s.scaleX||1}else if(this.options.expandCanvasToImage){let c=Math.max(h,Math.floor(a)),d=Math.max(n,Math.floor(o));this._setCanvasSizeInt(c,d),s.set({left:0,top:0}),s.scale(1),this.baseImageScale=1}else{let c=Math.max(this.options.canvasWidth,h),d=Math.max(this.options.canvasHeight,n);this._setCanvasSizeInt(c,d);let r=Math.min(c/a,d/o,1);s.set({left:(c-a*r)/2,top:(d-o*r)/2}),s.scale(r),this.baseImageScale=s.scaleX||1}this.originalImage=s,this.canvas.add(s),this.canvas.sendToBack(s),this._lastMaskInitialLeft=null,this._lastMaskInitialTop=null,this._lastMaskInitialWidth=null,this.maskCounter=0,this.currentScale=1,this.currentRotation=0,this._updateInputs(),this._updateMaskList(),this._updateUI(),this.canvas.renderAll(),this.isImageLoadedToCanvas=!0,typeof this.onImageLoaded=="function"&&this.onImageLoaded()},{crossOrigin:"anonymous"})}isImageLoaded(){return!!(this.originalImage&&this.originalImage instanceof fabric.Image&&this.originalImage.width>0&&this.originalImage.height>0)}_createImageElement(t){return new Promise((i,e)=>{let s=new Image;s.onload=()=>{s.onload=null,s.onerror=null,i(s)},s.onerror=a=>{s.onload=null,s.onerror=null,e(a)},s.src=t})}_resampleImageToDataURL(t,i,e,s=.92){let a=document.createElement("canvas");return a.width=i,a.height=e,a.getContext("2d").drawImage(t,0,0,t.naturalWidth,t.naturalHeight,0,0,i,e),a.toDataURL("image/jpeg",s)}_setCanvasSizeInt(t,i){let e=Math.max(1,Math.round(Number(t)||1)),s=Math.max(1,Math.round(Number(i)||1));this.canvas.setWidth(e),this.canvas.setHeight(s),typeof this.canvas.calcOffset=="function"&&this.canvas.calcOffset(),this.canvasEl&&(this.canvasEl.style.width=e+"px",this.canvasEl.style.height=s+"px",this.canvasEl.style.maxWidth="none")}_getObjectTopLeftPoint(t){if(!t)return{x:0,y:0};t.setCoords();let i=typeof t.getCoords=="function"?t.getCoords():null;if(i&&i.length)return i[0];let e=t.getBoundingRect(!0,!0);return{x:e.left,y:e.top}}_setObjectOriginKeepingPosition(t,i,e,s){!t||!s||!t.setPositionByOrigin||(t.set({originX:i,originY:e}),t.setPositionByOrigin(s,i,e),t.setCoords())}_alignObjectBoundingBoxToCanvasTopLeft(t){if(!t)return;t.setCoords();let i=t.getBoundingRect(!0,!0),e=i.left,s=i.top;t.set({left:(t.left||0)-e,top:(t.top||0)-s}),t.setCoords(),this.canvas.renderAll()}_updateCanvasSizeToImageBounds(){if(!this.originalImage)return;this.originalImage.setCoords();let t=this.originalImage.getBoundingRect(!0,!0),i=this.containerEl?Math.ceil(this.containerEl.clientWidth||0):0,e=this.containerEl?Math.ceil(this.containerEl.clientHeight||0):0;if(i>0&&e>0&&t.width<=i&&t.height<=e){this._setCanvasSizeInt(i,e);return}let s=Math.max(i||0,Math.floor(t.width)),a=Math.max(e||0,Math.floor(t.height));this._setCanvasSizeInt(s,a)}scaleImage(t){return this.animQueue.add(()=>this._scaleImageImpl(t))}_scaleImageImpl(t){if(!this.originalImage||this.isAnimating)return Promise.resolve();t=Math.max(this.options.minScale,Math.min(this.options.maxScale,t)),this.currentScale=t,this.isAnimating=!0,this._updateUI();let i=this.baseImageScale*t,e=this._getObjectTopLeftPoint(this.originalImage);this._setObjectOriginKeepingPosition(this.originalImage,"left","top",e);let s=new Promise(o=>{this.originalImage.animate("scaleX",i,{duration:this.options.animationDuration,onChange:this.canvas.renderAll.bind(this.canvas),onComplete:o})}),a=new Promise(o=>{this.originalImage.animate("scaleY",i,{duration:this.options.animationDuration,onChange:this.canvas.renderAll.bind(this.canvas),onComplete:o})});return Promise.all([s,a]).then(()=>{this.originalImage.set({scaleX:i,scaleY:i}),this.originalImage.setCoords(),this.options.expandCanvasToImage&&this._updateCanvasSizeToImageBounds(),this._alignObjectBoundingBoxToCanvasTopLeft(this.originalImage),this.canvas.getObjects().forEach(o=>{o.maskId&&this._syncMaskLabel(o)}),this.isAnimating=!1,this._updateInputs(),this._updateUI(),this.saveState()}).catch(()=>{this.isAnimating=!1,this._updateUI()})}rotateImage(t){return this.animQueue.add(()=>this._rotateImageImpl(t))}_rotateImageImpl(t){if(!this.originalImage||this.isAnimating||isNaN(t))return Promise.resolve();this.currentRotation=t,this.isAnimating=!0,this._updateUI();let i=this.originalImage.getCenterPoint();return this._setObjectOriginKeepingPosition(this.originalImage,"center","center",i),new Promise(s=>{this.originalImage.animate("angle",t,{duration:this.options.animationDuration,onChange:this.canvas.renderAll.bind(this.canvas),onComplete:s})}).then(()=>{this.originalImage.set("angle",t),this.originalImage.setCoords(),this.options.expandCanvasToImage&&this._updateCanvasSizeToImageBounds(),this._alignObjectBoundingBoxToCanvasTopLeft(this.originalImage);let s=this._getObjectTopLeftPoint(this.originalImage);this._setObjectOriginKeepingPosition(this.originalImage,"left","top",s),this.canvas.getObjects().forEach(a=>{a.maskId&&this._syncMaskLabel(a)}),this.isAnimating=!1,this._updateInputs(),this._updateUI(),this.saveState()}).catch(()=>{this.isAnimating=!1,this._updateUI()})}reset(){return this.originalImage?this.scaleImage(1).then(()=>this.rotateImage(0)).then(()=>{this.saveState()}).catch(t=>{console.error("reset() failed",t)}):Promise.resolve()}loadFromState(t){if(!(!t||!this.canvas))try{let i=typeof t=="string"?JSON.parse(t):t;this.canvas.loadFromJSON(i,()=>{this._hideAllMaskLabels();let e=this.canvas.getObjects();this.originalImage=e.find(a=>a.type==="image"&&!a.maskId)||null,this.originalImage.set({originX:"left",originY:"top",selectable:!1,evented:!1,hasControls:!1,hoverCursor:"default"}),this.canvas.sendToBack(this.originalImage);let s=e.filter(a=>a.maskId);this.maskCounter=s.reduce((a,o)=>Math.max(a,o.maskId),0),this.canvas.renderAll(),this._updateMaskList(),this._updateUI()})}catch(i){console.error("loadFromState() failed",i)}}saveState(){if(!this.canvas)return;let t=this.canvas.getActiveObject();this._hideAllMaskLabels();let i=JSON.stringify(this.canvas.toJSON(["maskId","maskName"])),e=this._lastSnapshot||i,s=!1,a=new E(()=>{s&&this.loadFromState(i),s=!0},()=>{this.loadFromState(e)});this.historyManager.execute(a),this._lastSnapshot=i,t&&t.maskId&&this._showLabelForMask(t),this._updateUI()}undo(){this.historyManager.undo()}redo(){this.historyManager.redo()}addMask(t={}){if(!this.canvas)return null;let i=t.shape||"rect",e={shape:i,width:this.options.defaultMaskWidth,height:this.options.defaultMaskHeight,color:"rgba(0,0,0,0.5)",alpha:.5,gap:5,left:void 0,top:void 0,angle:0,selectable:!0,...t},s=10,a=s,o=s,h=(r,l)=>{if(typeof r=="function")return r(this.canvas,this.options);if(typeof r=="string"&&r.endsWith("%")){let g=parseFloat(r)/100;return Math.floor((this.canvas?this.canvas.getWidth():0)*g)}return r??l};if(e.left===void 0&&this._lastMask){let r=this._lastMask,l=r.left;r.getScaledWidth?l+=r.getScaledWidth():r.width&&(l+=r.width*(r.scaleX??1)),a=Math.round(l+e.gap),o=r.top??s}else a=h(e.left,s),o=h(e.top,s);if(e.width=h(e.width,this.options.defaultMaskWidth),e.height=h(e.height,this.options.defaultMaskHeight),this.options.expandCanvasToImage&&i==="rect"){let r=Math.ceil(a+e.width+10),l=Math.ceil(o+e.height+10),g=this.containerEl?Math.floor(this.containerEl.clientWidth||0):0,u=this.containerEl?Math.floor(this.containerEl.clientHeight||0):0,m=Math.max(this.canvas.getWidth(),g,r),v=Math.max(this.canvas.getHeight(),u,l);this._setCanvasSizeInt(m,v)}let n;if(typeof e.fabricGenerator=="function")n=e.fabricGenerator(e,this.canvas,this.options);else switch(i){case"circle":n=new fabric.Circle({left:a,top:o,radius:h(e.radius,Math.min(e.width,e.height)/2),fill:e.color,opacity:e.alpha,angle:e.angle,...e.styles});break;case"ellipse":n=new fabric.Ellipse({left:a,top:o,rx:h(e.rx,e.width/2),ry:h(e.ry,e.height/2),fill:e.color,opacity:e.alpha,angle:e.angle,...e.styles});break;case"polygon":let r=e.points||[];Array.isArray(r)&&r.length&&typeof r[0]=="object"&&(r=r.map(l=>({x:Number(l.x),y:Number(l.y)}))),n=new fabric.Polygon(r,{left:a,top:o,fill:e.color,opacity:e.alpha,angle:e.angle,...e.styles});break;case"rect":default:n=new fabric.Rect({left:a,top:o,width:h(e.width,this.options.defaultMaskWidth),height:h(e.height,this.options.defaultMaskHeight),fill:e.color,opacity:e.alpha,angle:e.angle,rx:e.rx,ry:e.ry,...e.styles})}n.selectable=e.selectable!==!1,n.hasControls="hasControls"in e?e.hasControls:!0,n.lockRotation=!this.options.maskRotatable,n.borderColor=e.borderColor||"red",n.cornerColor=e.cornerColor||"black",n.cornerSize=e.cornerSize||8,n.transparentCorners="transparentCorners"in e?e.transparentCorners:!1,n.stroke=e.styles&&e.styles.stroke||"#ccc",n.strokeWidth=e.styles&&e.styles.strokeWidth||1,n.strokeUniform="strokeUniform"in e?e.strokeUniform:!0,e.styles&&e.styles.strokeDashArray&&(n.strokeDashArray=e.styles.strokeDashArray),n.originalAlpha=e.alpha;let c={stroke:n.stroke,strokeWidth:n.strokeWidth,opacity:n.originalAlpha},d={stroke:"#ff5500",strokeWidth:2,opacity:Math.min(n.originalAlpha+.2,1)};return n.on("mouseover",()=>{n.set(d),n.canvas.requestRenderAll()}),n.on("mouseout",()=>{n.set(c),n.canvas.requestRenderAll()}),this._lastMaskInitialLeft=a,this._lastMaskInitialTop=o,this._lastMaskInitialWidth=h(e.width,this.options.defaultMaskWidth),n.maskId=++this.maskCounter,n.maskName=`${this.options.maskName}${n.maskId}`,this._lastMask=n,this.canvas.add(n),this.canvas.bringToFront(n),e.selectable&&this.canvas.setActiveObject(n),this._onSelectionChanged([n]),this._updateMaskList(),this._updateUI(),this.canvas.renderAll(),this.saveState(),typeof e.onCreate=="function"&&e.onCreate(n,this.canvas),n}removeSelectedMask(){let t=this.canvas.getActiveObject();!t||!t.maskId||(this._removeLabelForMask(t),this.canvas.remove(t),this.canvas.discardActiveObject(),this._updateMaskList(),this._updateUI(),this.canvas.renderAll(),this.saveState())}removeAllMasks(){let t=this.canvas.getObjects().filter(i=>i.maskId);t.forEach(i=>this._removeLabelForMask(i)),t.forEach(i=>this.canvas.remove(i)),this.canvas.discardActiveObject(),this._lastMaskInitialLeft=null,this._lastMaskInitialTop=null,this._lastMaskInitialWidth=null,this._updateMaskList(),this._updateUI(),this.canvas.renderAll(),this.saveState()}_removeLabelForMask(t){if(!(!t||!this.canvas)&&t.__label){try{this.canvas.getObjects().includes(t.__label)&&this.canvas.remove(t.__label)}catch{}try{delete t.__label}catch{}}}_createLabelForMask(t){if(!t||!this.options.maskLabelOnSelect)return;this._removeLabelForMask(t);let i=null;if(this.options.label&&typeof this.options.label.create=="function"&&(i=this.options.label.create(t,fabric)),!i){let e=t.maskName,s={left:0,top:0,fontSize:12,fill:"#fff",backgroundColor:"rgba(0,0,0,0.7)",selectable:!1,evented:!1,padding:2,originX:"left",originY:"top"};this.options.label&&(typeof this.options.label.getText=="function"&&(e=this.options.label.getText(t,this.maskCounter)),this.options.label.textOptions&&Object.assign(s,this.options.label.textOptions)),i=new fabric.Text(e,s)}i.maskLabel=!0,t.__label=i,this.canvas.add(i),this.canvas.bringToFront(i),this._syncMaskLabel(t)}_hideAllMaskLabels(){if(!this.canvas)return;let t=this.canvas.getObjects();t.filter(e=>e.maskLabel).forEach(e=>{try{t.includes(e)&&this.canvas.remove(e)}catch{}}),t.forEach(e=>{if(e.maskId&&e.__label)try{delete e.__label}catch{}})}_syncMaskLabel(t){if(!t||!this.options.maskLabelOnSelect||!t.__label)return;let i=t.getCoords?t.getCoords():null;if(!i||i.length<4)return;let e=i[0],s=t.getCenterPoint(),a=s.x-e.x,o=s.y-e.y,h=Math.sqrt(a*a+o*o)||1,n=a/h,c=o/h,d=Math.max(0,this.options.maskLabelOffset??3),r=e.x+n*d,l=e.y+c*d;t.__label.set({left:Math.round(r),top:Math.round(l),angle:t.angle||0,originX:"left",originY:"top",visible:!0}),t.__label.setCoords(),this.canvas.renderAll()}_showLabelForMask(t){t&&this.options.maskLabelOnSelect&&(t.__label||this._createLabelForMask(t),t.__label.visible=!0,this._syncMaskLabel(t))}_onSelectionChanged(t){let i=(t||[]).find(s=>s.maskId);this.canvas.getObjects().filter(s=>s.maskId).forEach(s=>{if(s!==i){if(s.__label){try{this.canvas.remove(s.__label)}catch{}delete s.__label}s.set({stroke:"#ccc",strokeWidth:1})}else s.set({stroke:"#ff0000",strokeWidth:1})}),i&&this._showLabelForMask(i),this._updateMaskListSelection(i),this.canvas.renderAll(),this._updateUI()}_updateMaskList(){let t=document.getElementById(this.elements.maskList);if(!t)return;t.innerHTML="",this.canvas.getObjects().filter(e=>e.maskId).forEach(e=>{let s=document.createElement("li");s.className="list-group-item mask-item",s.textContent=e.maskName,s.onclick=()=>{this.canvas.setActiveObject(e),this._onSelectionChanged([e])},t.appendChild(s)})}_updateMaskListSelection(t){let i=document.getElementById(this.elements.maskList);if(!i)return;i.querySelectorAll(".mask-item").forEach(s=>{let a=!!t&&s.textContent===t.maskName;s.classList.toggle("active",a)})}async merge(){if(!(!this.originalImage||!this.canvas.getObjects().filter(i=>i.maskId).length)){this.canvas.discardActiveObject(),this.canvas.renderAll();try{let i=await this.getImageBase64({exportImageArea:!0,multiplier:this.options.exportMultiplier});this.removeAllMasks(),await this.loadImage(i),this.saveState()}catch(i){console.error("merge error",i),this.canvasEl&&(this.canvasEl.style.visibility="")}}}downloadImage(t=this.options.defaultDownloadFileName){if(!this.originalImage)return;let i=this.options.exportImageAreaByDefault;this.getImageBase64({exportImageArea:i,multiplier:this.options.exportMultiplier}).then(e=>{let s=document.createElement("a");s.download=t,s.href=e,document.body.appendChild(s),s.click(),document.body.removeChild(s)}).catch(e=>console.error("download error",e))}async getImageBase64(t={}){if(!this.originalImage)throw new Error("No image loaded");let i=typeof t.exportImageArea=="boolean"?t.exportImageArea:this.options.exportImageAreaByDefault,e=t.multiplier||this.options.exportMultiplier||1;if(!i){let l=this.originalImage.getElement?this.originalImage.getElement():this.originalImage._element||null;if(!l)return this.canvas.toDataURL({format:"jpeg",quality:this.options.downsampleQuality,multiplier:e});let g=this.originalImage.width,u=this.originalImage.height,m=document.createElement("canvas");return m.width=g,m.height=u,m.getContext("2d").drawImage(l,0,0,g,u),m.toDataURL("image/jpeg",this.options.downsampleQuality)}let s=this.canvas.getObjects().filter(l=>l.maskId),a=s.map(l=>({obj:l,opacity:l.opacity,fill:l.fill,strokeWidth:l.strokeWidth,stroke:l.stroke,selectable:l.selectable,lockRotation:l.lockRotation}));s.forEach(l=>this._removeLabelForMask(l)),this.canvas.discardActiveObject(),this.canvas.renderAll(),s.forEach(l=>{l.set({opacity:1,fill:"#000000",strokeWidth:0,stroke:null,selectable:!1}),l.setCoords()}),this.canvas.renderAll(),this.originalImage.setCoords();let o=this.originalImage.getBoundingRect(!0,!0),h=Math.max(0,Math.round(o.left)),n=Math.max(0,Math.round(o.top)),c=Math.max(1,Math.round(o.width)),d=Math.max(1,Math.round(o.height)),r=await new Promise((l,g)=>{try{let u=this.canvas.toDataURL({format:"jpeg",quality:this.options.downsampleQuality,multiplier:e}),m=new Image;m.onload=()=>{try{let v=Math.round(h*e),_=Math.round(n*e),p=Math.round(c*e),I=Math.round(d*e),k=document.createElement("canvas");k.width=p,k.height=I,k.getContext("2d").drawImage(m,v,_,p,I,0,0,p,I);let C=k.toDataURL("image/jpeg",this.options.downsampleQuality);l(C)}catch(v){g(v)}},m.onerror=g,m.src=u}catch(u){g(u)}});return a.forEach(l=>{try{l.obj.set({opacity:l.opacity,fill:l.fill,strokeWidth:l.strokeWidth,stroke:l.stroke,selectable:l.selectable,lockRotation:l.lockRotation}),l.obj.setCoords()}catch{}}),this.canvas.renderAll(),r}async exportImageFile(t={}){if(!this.originalImage)throw new Error("No image loaded");let{mergeMask:i=!0,fileType:e="jpeg",quality:s=this.options.downsampleQuality??.92,multiplier:a=this.options.exportMultiplier??1,fileName:o=this.options.defaultDownloadFileName??"exported_image.jpg"}=t,n={jpeg:"jpeg",jpg:"jpeg","image/jpeg":"jpeg",png:"png","image/png":"png",webp:"webp","image/webp":"webp"}[String(e).toLowerCase()]||"jpeg",c;i?c=await this.getImageBase64({exportImageArea:!0,multiplier:a}):c=await this.getImageBase64({exportImageArea:!1,multiplier:a});let d=c;d.startsWith(`data:image/${n}`)||(d=await new Promise((v,_)=>{let p=new window.Image;p.crossOrigin="Anonymous",p.onload=()=>{try{let I=document.createElement("canvas");I.width=p.width,I.height=p.height,I.getContext("2d").drawImage(p,0,0);let x=I.toDataURL(`image/${n}`,s);v(x)}catch(I){_(I)}},p.onerror=_,p.src=c}));let r=atob(d.split(",")[1]),l=`image/${n}`,g=r.length,u=new Uint8Array(g);for(;g--;)u[g]=r.charCodeAt(g);return new File([u],o,{type:l})}_updateInputs(){let t=document.getElementById(this.elements.scaleRate);t&&(t.value=Math.round(this.currentScale*100))}_updateUI(){let t=!!this.originalImage,e=(t?this.canvas.getObjects().filter(c=>c.maskId):[]).length>0,s=this.canvas.getActiveObject(),a=s&&s.maskId,o=this.currentScale===1&&this.currentRotation===0,h=this.historyManager?.canUndo(),n=this.historyManager?.canRedo();this._setDisabled("zoomInBtn",!t||this.isAnimating||this.currentScale>=this.options.maxScale),this._setDisabled("zoomOutBtn",!t||this.isAnimating||this.currentScale<=this.options.minScale),this._setDisabled("addMaskBtn",!t||this.isAnimating),this._setDisabled("removeMaskBtn",!a||this.isAnimating),this._setDisabled("removeAllMasksBtn",!e||this.isAnimating),this._setDisabled("mergeBtn",!t||!e||this.isAnimating),this._setDisabled("downloadBtn",!t||this.isAnimating),this._setDisabled("resetBtn",!t||o||this.isAnimating),this._setDisabled("undoBtn",!t||this.isAnimating||!h),this._setDisabled("redoBtn",!t||this.isAnimating||!n)}_setDisabled(t,i){let e=document.getElementById(this.elements[t]);e&&(e.disabled=!!i)}_updatePlaceholderStatus(){this.options.showPlaceholder&&this._setPlaceholderVisible(!this.originalImage)}_setPlaceholderVisible(t){this.placeholderEl&&(t?(this.placeholderEl.classList.remove("d-none"),this.placeholderEl.classList.add("d-flex"),this.containerEl.classList.add("d-none")):(this.placeholderEl.classList.remove("d-flex"),this.placeholderEl.classList.add("d-none"),this.containerEl.classList.remove("d-none")))}dispose(){try{for(let t in this._boundHandlers||{}){let i=this._boundHandlers[t]||[],e=document.getElementById(this.elements[t]);e&&i.forEach(s=>{try{e.removeEventListener(s.event,s.handler)}catch{}})}}catch{}if(this.canvas){try{this.canvas.dispose()}catch{}this.canvas=null,this.canvasEl=null,this.isImageLoadedToCanvas=!1}this._boundHandlers={}}}class f{constructor(){this.queue=[],this.running=!1}async add(t){return new Promise((i,e)=>{this.queue.push({fn:t,resolve:i,reject:e}),this.running||this.processQueue()})}async processQueue(){if(this.queue.length===0){this.running=!1;return}this.running=!0;let{fn:t,resolve:i,reject:e}=this.queue.shift();try{let s=await t();i(s)}catch(s){e(s)}this.processQueue()}}class E{constructor(t,i){this.execute=t,this.undo=i}}class L{constructor(t=50){this.history=[],this.currentIndex=-1,this.maxSize=t}execute(t){t.execute(),this.currentIndex<this.history.length-1&&(this.history=this.history.slice(0,this.currentIndex+1)),this.history.push(t),this.history.length>this.maxSize?this.history.shift():this.currentIndex++}canUndo(){return this.currentIndex>=0}canRedo(){return this.currentIndex<this.history.length-1}undo(){this.currentIndex>=0&&(this.history[this.currentIndex].undo(),this.currentIndex--)}redo(){this.currentIndex<this.history.length-1&&(this.currentIndex++,this.history[this.currentIndex].execute())}}return b})});export default S();
//# sourceMappingURL=image-editor.esm.min.js.map
